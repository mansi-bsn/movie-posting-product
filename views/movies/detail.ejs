<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= movie.title %> - Movie Posting Product</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        :root { --header-height: 90px; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; padding-top: var(--header-height); }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; }
        .header h1 { margin: 0; font-weight: 700; font-size: 2rem; }
        .sidebar { position: fixed; left: 0; top: var(--header-height); height: calc(100vh - var(--header-height)); width: 250px; background: white; box-shadow: 2px 0 10px rgba(0,0,0,0.1); padding: 20px 0; overflow-y: auto; }
        .sidebar-menu { list-style: none; padding: 0; }
        .sidebar-menu li { margin: 0; }
        .sidebar-menu a { display: block; padding: 15px 25px; color: #333; text-decoration: none; transition: all 0.3s; border-left: 3px solid transparent; }
        .sidebar-menu a:hover, .sidebar-menu a.active { background: #f8f9fa; border-left-color: #667eea; color: #667eea; }
        .sidebar-menu a i { margin-right: 10px; width: 20px; }
        .main-content { margin-left: 250px; padding: 30px; min-height: calc(100vh - var(--header-height)); }
        .movie-hero { background: white; border-radius: 15px; padding: 30px; margin-bottom: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .movie-poster { width: 100%; max-width: 400px; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); }
        .star-rating { color: #ffc107; font-size: 1.5rem; }
        .review-card { background: white; border-radius: 10px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 20px; }
        .gallery-item { border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .gallery-item img { width: 100%; height: 200px; object-fit: cover; }
        .trailer-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 10px; margin-top: 20px; }
        .trailer-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .btn-watchlist { background: #dc3545; border: none; color: white; }
        .btn-watchlist.active { background: #28a745; }
        .user-info { display: flex; align-items: center; gap: 10px; color: white; }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="container-fluid px-4">
            <div class="d-flex justify-content-between align-items-center">
                <h1><i class="bi bi-film"></i> Movie Posting Product</h1>
                <div class="user-info">
                    <span><i class="bi bi-person-circle"></i> <%= user.username %></span>
                    <a href="/logout" class="btn btn-light btn-sm">Logout</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar">
        <ul class="sidebar-menu">
            <li><a href="/movies"><i class="bi bi-list-ul"></i> All Movies</a></li>
            <li><a href="/movies/add"><i class="bi bi-plus-circle"></i> Add Movie</a></li>
            <li><a href="/my-watchlist"><i class="bi bi-heart"></i> My Watchlist</a></li>
            <li><a href="/profile"><i class="bi bi-person"></i> Profile</a></li>
            <% if (user.role === 'admin') { %>
            <li><a href="/admin/dashboard"><i class="bi bi-speedometer2"></i> Admin Dashboard</a></li>
            <% } %>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="movie-hero">
            <div class="row">
                <div class="col-md-4">
                    <% if (movie.poster) { %>
                        <img src="<%= movie.poster %>" alt="<%= movie.title %>" class="movie-poster">
                    <% } else { %>
                        <div class="movie-poster bg-light d-flex align-items-center justify-content-center" style="height: 600px;">
                            <i class="bi bi-image" style="font-size: 4rem; color: #ccc;"></i>
                        </div>
                    <% } %>
                </div>
                <div class="col-md-8">
                    <h1 class="mb-3"><%= movie.title %></h1>
                    
                    <div class="mb-3">
                        <div class="star-rating mb-2">
                            <% for(let i = 1; i <= 5; i++) { %>
                                <i class="bi bi-star<%= i <= Math.round(avgRating) ? '-fill' : '' %>"></i>
                            <% } %>
                            <span class="ms-2 text-dark">(<%= avgRating.toFixed(1) %> / 5.0)</span>
                        </div>
                        <p class="text-muted"><%= reviews.length %> reviews</p>
                    </div>
                    
                    <div class="mb-3">
                        <button class="btn btn-watchlist <%= inWatchlist ? 'active' : '' %>" id="watchlistBtn">
                            <i class="bi bi-heart<%= inWatchlist ? '-fill' : '' %>"></i> 
                            <%= inWatchlist ? 'Remove from Watchlist' : 'Add to Watchlist' %>
                        </button>
                    </div>
                    
                    <div class="mb-3">
                        <strong>Genres:</strong> 
                        <% movie.genre.forEach((g, idx) => { %>
                            <span class="badge bg-primary me-1"><%= g %></span>
                        <% }); %>
                    </div>
                    
                    <div class="mb-3">
                        <strong>Release Date:</strong> 
                        <%= new Date(movie.releaseDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) %>
                    </div>
                    
                    <% if (movie.director) { %>
                    <div class="mb-3">
                        <strong>Director:</strong> 
                        <a href="/directors/<%= movie.director._id %>"><%= movie.director.name %></a>
                    </div>
                    <% } %>
                    
                    <% if (movie.actors && movie.actors.length > 0) { %>
                    <div class="mb-3">
                        <strong>Cast:</strong> 
                        <% movie.actors.forEach((actor, idx) => { %>
                            <a href="/actors/<%= actor._id %>"><%= actor.name %></a><%= idx < movie.actors.length - 1 ? ', ' : '' %>
                        <% }); %>
                    </div>
                    <% } %>
                    
                    <div class="mb-3">
                        <strong>Views:</strong> <%= movie.views || 0 %>
                    </div>
                    
                    <p class="mt-4"><%= movie.description %></p>
                </div>
            </div>
        </div>

        <!-- Trailer Section -->
        <% if (movie.trailerUrl) { %>
        <div class="movie-hero">
            <h3 class="mb-3">Trailer</h3>
            <div class="trailer-container">
                <iframe 
                    src="<%= movie.trailerUrl %>" 
                    frameborder="0" 
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                    allowfullscreen>
                </iframe>
            </div>
        </div>
        <% } %>

        <!-- Gallery Section -->
        <% if (movie.gallery && movie.gallery.length > 0) { %>
        <div class="movie-hero">
            <h3 class="mb-3">Gallery</h3>
            <div class="gallery-grid">
                <% movie.gallery.forEach(image => { %>
                    <div class="gallery-item">
                        <img src="<%= image %>" alt="Gallery image" class="img-fluid">
                    </div>
                <% }); %>
            </div>
        </div>
        <% } %>

        <!-- Reviews Section -->
        <div class="movie-hero">
            <h3 class="mb-4">Reviews & Ratings</h3>
            
            <!-- Review Form -->
            <% if (!userReview) { %>
            <div class="review-card mb-4">
                <h5>Write a Review</h5>
                <form id="reviewForm">
                    <div class="mb-3">
                        <label class="form-label">Rating</label>
                        <div class="star-rating-input">
                            <% for(let i = 1; i <= 5; i++) { %>
                                <i class="bi bi-star star-input" data-rating="<%= i %>" style="cursor: pointer; font-size: 2rem; color: #ccc;"></i>
                            <% } %>
                        </div>
                        <input type="hidden" id="ratingValue" name="rating" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Review (Optional)</label>
                        <textarea class="form-control" name="review" rows="3" maxlength="1000"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Submit Review</button>
                </form>
            </div>
            <% } else { %>
            <div class="alert alert-info">You have already reviewed this movie.</div>
            <% } %>
            
            <!-- Reviews List -->
            <h5 class="mb-3">All Reviews (<%= reviews.length %>)</h5>
            <% if (reviews.length > 0) { %>
                <% reviews.forEach(review => { %>
                    <div class="review-card">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <strong><%= review.user.username %></strong>
                                <div class="star-rating">
                                    <% for(let i = 1; i <= 5; i++) { %>
                                        <i class="bi bi-star<%= i <= review.rating ? '-fill' : '' %>"></i>
                                    <% } %>
                                </div>
                            </div>
                            <small class="text-muted"><%= new Date(review.createdAt).toLocaleDateString() %></small>
                        </div>
                        <% if (review.review) { %>
                            <p class="mb-0"><%= review.review %></p>
                        <% } %>
                        <% if (user.role === 'admin') { %>
                            <button class="btn btn-sm btn-danger mt-2" onclick="deleteReview('<%= review._id %>')">Delete</button>
                        <% } %>
                    </div>
                <% }); %>
            <% } else { %>
                <p class="text-muted">No reviews yet. Be the first to review!</p>
            <% } %>
        </div>

        <!-- Related Movies -->
        <% if (relatedMovies && relatedMovies.length > 0) { %>
        <div class="movie-hero">
            <h3 class="mb-4">Related Movies</h3>
            <div class="row">
                <% relatedMovies.forEach(relatedMovie => { %>
                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <% if (relatedMovie.poster) { %>
                                <img src="<%= relatedMovie.poster %>" class="card-img-top" style="height: 300px; object-fit: cover;">
                            <% } %>
                            <div class="card-body">
                                <h5 class="card-title"><a href="/movies/<%= relatedMovie._id %>"><%= relatedMovie.title %></a></h5>
                                <div class="star-rating">
                                    <% for(let i = 1; i <= 5; i++) { %>
                                        <i class="bi bi-star<%= i <= Math.round(relatedMovie.averageRating) ? '-fill' : '' %>"></i>
                                    <% } %>
                                    <span class="ms-1">(<%= relatedMovie.averageRating.toFixed(1) %>)</span>
                                </div>
                            </div>
                        </div>
                    </div>
                <% }); %>
            </div>
        </div>
        <% } %>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const movieId = '<%= movie._id %>';
        
        // Star rating input
        const stars = document.querySelectorAll('.star-input');
        const ratingInput = document.getElementById('ratingValue');
        let selectedRating = 0;
        
        stars.forEach((star, index) => {
            star.addEventListener('click', () => {
                selectedRating = index + 1;
                ratingInput.value = selectedRating;
                stars.forEach((s, i) => {
                    s.classList.toggle('bi-star-fill', i < selectedRating);
                    s.classList.toggle('bi-star', i >= selectedRating);
                    s.style.color = i < selectedRating ? '#ffc107' : '#ccc';
                });
            });
            star.addEventListener('mouseenter', () => {
                stars.forEach((s, i) => {
                    s.style.color = i <= index ? '#ffc107' : '#ccc';
                });
            });
        });
        
        // Review form submission
        document.getElementById('reviewForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {
                movieId: movieId,
                rating: formData.get('rating'),
                review: formData.get('review')
            };
            
            try {
                const response = await fetch('/api/reviews', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (result.success) {
                    location.reload();
                } else {
                    alert('Error submitting review');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error submitting review');
            }
        });
        
        // Watchlist toggle
        document.getElementById('watchlistBtn')?.addEventListener('click', async () => {
            try {
                const response = await fetch('/api/watchlist/toggle', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ movieId: movieId })
                });
                const result = await response.json();
                if (result.success) {
                    location.reload();
                }
            } catch (error) {
                console.error('Error:', error);
            }
        });
        
        // Delete review (admin)
        async function deleteReview(reviewId) {
            if (!confirm('Are you sure you want to delete this review?')) return;
            try {
                const response = await fetch(`/api/reviews/${reviewId}`, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    location.reload();
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }
    </script>
</body>
</html>

